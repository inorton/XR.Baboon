<!DOCTYPE html>
<html>
<head><title>/StatsdClient/Statsd.cs</title></head>

<style>
.num {
  text-align:right;
  padding-right:3px;
  font-size:80%;
}
.hit-count-good {
  background-color:#73b973;
}
.hit-count-bad {
  background-color:#ff7373;
}
.code {
  font-family:monospace;
}
.nm-cov-good {
  background-color:#a2d0a2;
}
.nm-cov-bad {
  background-color:#ffa2a2;
}
pre {
  margin:0px;
}
body {
  font-family:sans-serif;
}
</style>
<body>
<table cellspacing='0' cellpadding='0'>
<tr><td class='num'>1&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>using System;</span></pre></td></tr>
<tr><td class='num'>2&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>using System.Collections.Generic;</span></pre></td></tr>
<tr><td class='num'>3&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>using System.Diagnostics;</span></pre></td></tr>
<tr><td class='num'>4&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>using System.Globalization;</span></pre></td></tr>
<tr><td class='num'>5&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'></span></pre></td></tr>
<tr><td class='num'>6&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>namespace StatsdClient</span></pre></td></tr>
<tr><td class='num'>7&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>{</span></pre></td></tr>
<tr><td class='num'>8&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>    public class Statsd : IStatsd</span></pre></td></tr>
<tr><td class='num'>9&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>    {</span></pre></td></tr>
<tr><td class='num'>10&nbsp;</td><td class='num hit-count-good'>103&nbsp;</td><td><pre><span class='code nm-cov-good'>        private IStopWatchFactory StopwatchFactory { get; set; }</span></pre></td></tr>
<tr><td class='num'>11&nbsp;</td><td class='num hit-count-good'>1240&nbsp;</td><td><pre><span class='code nm-cov-good'>        private IStatsdUDP Udp { get; set; }</span></pre></td></tr>
<tr><td class='num'>12&nbsp;</td><td class='num hit-count-good'>197&nbsp;</td><td><pre><span class='code nm-cov-good'>        private IRandomGenerator RandomGenerator { get; set; }</span></pre></td></tr>
<tr><td class='num'>13&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'></span></pre></td></tr>
<tr><td class='num'>14&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>        private readonly string _prefix;</span></pre></td></tr>
<tr><td class='num'>15&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'></span></pre></td></tr>
<tr><td class='num'>16&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>        public List&lt;string&gt; Commands</span></pre></td></tr>
<tr><td class='num'>17&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>        {</span></pre></td></tr>
<tr><td class='num'>18&nbsp;</td><td class='num hit-count-good'>3657&nbsp;</td><td><pre><span class='code nm-cov-good'>            get { return _commands; }</span></pre></td></tr>
<tr><td class='num'>19&nbsp;</td><td class='num hit-count-good'>27&nbsp;</td><td><pre><span class='code nm-cov-good'>            private set { _commands = value; }</span></pre></td></tr>
<tr><td class='num'>20&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>        }</span></pre></td></tr>
<tr><td class='num'>21&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'></span></pre></td></tr>
<tr><td class='num'>22&nbsp;</td><td class='num hit-count-good'>178&nbsp;</td><td><pre><span class='code nm-cov-good'>        private List&lt;string&gt; _commands = new List&lt;string&gt;();</span></pre></td></tr>
<tr><td class='num'>23&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'></span></pre></td></tr>
<tr><td class='num'>24&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>        public abstract class Metric : ICommandType</span></pre></td></tr>
<tr><td class='num'>25&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>        {</span></pre></td></tr>
<tr><td class='num'>26&nbsp;</td><td class='num hit-count-good'>1&nbsp;</td><td><pre><span class='code nm-cov-good'>            private static readonly Dictionary&lt;Type, string&gt; _commandToUnit = new Dictionary&lt;Type, string&gt;</span></pre></td></tr>
<tr><td class='num'>27&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                                                                {</span></pre></td></tr>
<tr><td class='num'>28&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                                                                    {typeof (Counting), &quot;c&quot;},</span></pre></td></tr>
<tr><td class='num'>29&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                                                                    {typeof (Timing), &quot;ms&quot;},</span></pre></td></tr>
<tr><td class='num'>30&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                                                                    {typeof (Gauge), &quot;g&quot;},</span></pre></td></tr>
<tr><td class='num'>31&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                                                                    {typeof (Histogram), &quot;h&quot;},</span></pre></td></tr>
<tr><td class='num'>32&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                                                                    {typeof (Meter), &quot;m&quot;},</span></pre></td></tr>
<tr><td class='num'>33&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                                                                    {typeof (Set), &quot;s&quot;}</span></pre></td></tr>
<tr><td class='num'>34&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                                                                };</span></pre></td></tr>
<tr><td class='num'>35&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'></span></pre></td></tr>
<tr><td class='num'>36&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>            public static string GetCommand&lt;TCommandType, T&gt;(string prefix, string name, T value, double sampleRate, string[] tags) where TCommandType : Metric</span></pre></td></tr>
<tr><td class='num'>37&nbsp;</td><td class='num hit-count-good'>154&nbsp;</td><td><pre><span class='code nm-cov-good'>            {</span></pre></td></tr>
<tr><td class='num'>38&nbsp;</td><td class='num hit-count-good'>154&nbsp;</td><td><pre><span class='code nm-cov-good'>                string full_name = prefix + name;</span></pre></td></tr>
<tr><td class='num'>39&nbsp;</td><td class='num hit-count-good'>308&nbsp;</td><td><pre><span class='code nm-cov-good'>                string unit = _commandToUnit[typeof(TCommandType)];</span></pre></td></tr>
<tr><td class='num'>40&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                // It would be cleaner to do this with StringBuilder, but we want sending stats to be as fast as possible</span></pre></td></tr>
<tr><td class='num'>41&nbsp;</td><td class='num hit-count-good'>154&nbsp;</td><td><pre><span class='code nm-cov-good'>                if (sampleRate == 1.0 &amp;&amp; (tags == null || tags.Length == 0))</span></pre></td></tr>
<tr><td class='num'>42&nbsp;</td><td class='num hit-count-good'>136&nbsp;</td><td><pre><span class='code nm-cov-good'>                    return string.Format(CultureInfo.InvariantCulture, &quot;{0}:{1}|{2}&quot;, full_name, value, unit);</span></pre></td></tr>
<tr><td class='num'>43&nbsp;</td><td class='num hit-count-good'>86&nbsp;</td><td><pre><span class='code nm-cov-good'>                else if (sampleRate == 1.0 &amp;&amp; (tags == null || tags.Length &gt; 0))</span></pre></td></tr>
<tr><td class='num'>44&nbsp;</td><td class='num hit-count-good'>78&nbsp;</td><td><pre><span class='code nm-cov-good'>                    return string.Format(CultureInfo.InvariantCulture, &quot;{0}:{1}|{2}|#{3}&quot;, full_name, value, unit, string.Join(&quot;,&quot;, tags));</span></pre></td></tr>
<tr><td class='num'>45&nbsp;</td><td class='num hit-count-good'>60&nbsp;</td><td><pre><span class='code nm-cov-good'>                else if (sampleRate != 1.0 &amp;&amp; (tags == null || tags.Length == 0))</span></pre></td></tr>
<tr><td class='num'>46&nbsp;</td><td class='num hit-count-good'>58&nbsp;</td><td><pre><span class='code nm-cov-good'>                    return string.Format(CultureInfo.InvariantCulture, &quot;{0}:{1}|{2}|@{3}&quot;, full_name, value, unit, sampleRate);</span></pre></td></tr>
<tr><td class='num'>47&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                else // { if (sampleRate != 1 &amp;&amp; (tags == null || tags.Length &gt; 0)) }</span></pre></td></tr>
<tr><td class='num'>48&nbsp;</td><td class='num hit-count-good'>62&nbsp;</td><td><pre><span class='code nm-cov-good'>                    return string.Format(CultureInfo.InvariantCulture, &quot;{0}:{1}|{2}|@{3}|#{4}&quot;, full_name, value, unit, sampleRate,</span></pre></td></tr>
<tr><td class='num'>49&nbsp;</td><td class='num hit-count-good'>31&nbsp;</td><td><pre><span class='code nm-cov-good'>                                         string.Join(&quot;,&quot;, tags));</span></pre></td></tr>
<tr><td class='num'>50&nbsp;</td><td class='num hit-count-good'>154&nbsp;</td><td><pre><span class='code nm-cov-good'>            }</span></pre></td></tr>
<tr><td class='num'>51&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>        }</span></pre></td></tr>
<tr><td class='num'>52&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'></span></pre></td></tr>
<tr><td class='num'>53&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>        public class Event : ICommandType</span></pre></td></tr>
<tr><td class='num'>54&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>        {</span></pre></td></tr>
<tr><td class='num'>55&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>            private const int MaxSize = 8 * 1024;</span></pre></td></tr>
<tr><td class='num'>56&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'></span></pre></td></tr>
<tr><td class='num'>57&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>            public static string GetCommand(string title, string text, string alertType, string aggregationKey, string sourceType, int? dateHappened, string priority, string hostname, string[] tags, bool truncateIfTooLong = false)</span></pre></td></tr>
<tr><td class='num'>58&nbsp;</td><td class='num hit-count-good'>15&nbsp;</td><td><pre><span class='code nm-cov-good'>            {</span></pre></td></tr>
<tr><td class='num'>59&nbsp;</td><td class='num hit-count-good'>30&nbsp;</td><td><pre><span class='code nm-cov-good'>                string processedTitle = EscapeContent(title);</span></pre></td></tr>
<tr><td class='num'>60&nbsp;</td><td class='num hit-count-good'>30&nbsp;</td><td><pre><span class='code nm-cov-good'>                string processedText = EscapeContent(text);</span></pre></td></tr>
<tr><td class='num'>61&nbsp;</td><td class='num hit-count-good'>90&nbsp;</td><td><pre><span class='code nm-cov-good'>                string result = string.Format(CultureInfo.InvariantCulture, &quot;_e{{{0},{1}}}:{2}|{3}&quot;, processedTitle.Length.ToString(), processedText.Length.ToString(), processedTitle, processedText);</span></pre></td></tr>
<tr><td class='num'>62&nbsp;</td><td class='num hit-count-good'>15&nbsp;</td><td><pre><span class='code nm-cov-good'>                if (dateHappened != null)</span></pre></td></tr>
<tr><td class='num'>63&nbsp;</td><td class='num hit-count-good'>2&nbsp;</td><td><pre><span class='code nm-cov-good'>                {</span></pre></td></tr>
<tr><td class='num'>64&nbsp;</td><td class='num hit-count-good'>6&nbsp;</td><td><pre><span class='code nm-cov-good'>                    result += string.Format(CultureInfo.InvariantCulture, &quot;|d:{0}&quot;, dateHappened);</span></pre></td></tr>
<tr><td class='num'>65&nbsp;</td><td class='num hit-count-good'>2&nbsp;</td><td><pre><span class='code nm-cov-good'>                }</span></pre></td></tr>
<tr><td class='num'>66&nbsp;</td><td class='num hit-count-good'>15&nbsp;</td><td><pre><span class='code nm-cov-good'>                if (hostname != null)</span></pre></td></tr>
<tr><td class='num'>67&nbsp;</td><td class='num hit-count-good'>1&nbsp;</td><td><pre><span class='code nm-cov-good'>                {</span></pre></td></tr>
<tr><td class='num'>68&nbsp;</td><td class='num hit-count-good'>3&nbsp;</td><td><pre><span class='code nm-cov-good'>                    result += string.Format(CultureInfo.InvariantCulture, &quot;|h:{0}&quot;, hostname);</span></pre></td></tr>
<tr><td class='num'>69&nbsp;</td><td class='num hit-count-good'>1&nbsp;</td><td><pre><span class='code nm-cov-good'>                }</span></pre></td></tr>
<tr><td class='num'>70&nbsp;</td><td class='num hit-count-good'>15&nbsp;</td><td><pre><span class='code nm-cov-good'>                if (aggregationKey != null)</span></pre></td></tr>
<tr><td class='num'>71&nbsp;</td><td class='num hit-count-good'>2&nbsp;</td><td><pre><span class='code nm-cov-good'>                {</span></pre></td></tr>
<tr><td class='num'>72&nbsp;</td><td class='num hit-count-good'>6&nbsp;</td><td><pre><span class='code nm-cov-good'>                    result += string.Format(CultureInfo.InvariantCulture, &quot;|k:{0}&quot;, aggregationKey);</span></pre></td></tr>
<tr><td class='num'>73&nbsp;</td><td class='num hit-count-good'>2&nbsp;</td><td><pre><span class='code nm-cov-good'>                }</span></pre></td></tr>
<tr><td class='num'>74&nbsp;</td><td class='num hit-count-good'>15&nbsp;</td><td><pre><span class='code nm-cov-good'>                if (priority != null)</span></pre></td></tr>
<tr><td class='num'>75&nbsp;</td><td class='num hit-count-good'>2&nbsp;</td><td><pre><span class='code nm-cov-good'>                {</span></pre></td></tr>
<tr><td class='num'>76&nbsp;</td><td class='num hit-count-good'>6&nbsp;</td><td><pre><span class='code nm-cov-good'>                    result += string.Format(CultureInfo.InvariantCulture, &quot;|p:{0}&quot;, priority);</span></pre></td></tr>
<tr><td class='num'>77&nbsp;</td><td class='num hit-count-good'>2&nbsp;</td><td><pre><span class='code nm-cov-good'>                }</span></pre></td></tr>
<tr><td class='num'>78&nbsp;</td><td class='num hit-count-good'>15&nbsp;</td><td><pre><span class='code nm-cov-good'>                if (sourceType != null)</span></pre></td></tr>
<tr><td class='num'>79&nbsp;</td><td class='num hit-count-good'>1&nbsp;</td><td><pre><span class='code nm-cov-good'>                {</span></pre></td></tr>
<tr><td class='num'>80&nbsp;</td><td class='num hit-count-good'>3&nbsp;</td><td><pre><span class='code nm-cov-good'>                    result += string.Format(CultureInfo.InvariantCulture, &quot;|s:{0}&quot;, sourceType);</span></pre></td></tr>
<tr><td class='num'>81&nbsp;</td><td class='num hit-count-good'>1&nbsp;</td><td><pre><span class='code nm-cov-good'>                }</span></pre></td></tr>
<tr><td class='num'>82&nbsp;</td><td class='num hit-count-good'>15&nbsp;</td><td><pre><span class='code nm-cov-good'>                if (alertType != null)</span></pre></td></tr>
<tr><td class='num'>83&nbsp;</td><td class='num hit-count-good'>1&nbsp;</td><td><pre><span class='code nm-cov-good'>                {</span></pre></td></tr>
<tr><td class='num'>84&nbsp;</td><td class='num hit-count-good'>3&nbsp;</td><td><pre><span class='code nm-cov-good'>                    result += string.Format(CultureInfo.InvariantCulture, &quot;|t:{0}&quot;, alertType);</span></pre></td></tr>
<tr><td class='num'>85&nbsp;</td><td class='num hit-count-good'>1&nbsp;</td><td><pre><span class='code nm-cov-good'>                }</span></pre></td></tr>
<tr><td class='num'>86&nbsp;</td><td class='num hit-count-good'>15&nbsp;</td><td><pre><span class='code nm-cov-good'>                if (tags != null)</span></pre></td></tr>
<tr><td class='num'>87&nbsp;</td><td class='num hit-count-good'>2&nbsp;</td><td><pre><span class='code nm-cov-good'>                {</span></pre></td></tr>
<tr><td class='num'>88&nbsp;</td><td class='num hit-count-good'>8&nbsp;</td><td><pre><span class='code nm-cov-good'>                    result += string.Format(CultureInfo.InvariantCulture, &quot;|#{0}&quot;, string.Join(&quot;,&quot;, tags));</span></pre></td></tr>
<tr><td class='num'>89&nbsp;</td><td class='num hit-count-good'>2&nbsp;</td><td><pre><span class='code nm-cov-good'>                }</span></pre></td></tr>
<tr><td class='num'>90&nbsp;</td><td class='num hit-count-good'>30&nbsp;</td><td><pre><span class='code nm-cov-good'>                if (result.Length &gt; MaxSize)</span></pre></td></tr>
<tr><td class='num'>91&nbsp;</td><td class='num hit-count-good'>3&nbsp;</td><td><pre><span class='code nm-cov-good'>                {</span></pre></td></tr>
<tr><td class='num'>92&nbsp;</td><td class='num hit-count-good'>3&nbsp;</td><td><pre><span class='code nm-cov-good'>                    if (truncateIfTooLong)</span></pre></td></tr>
<tr><td class='num'>93&nbsp;</td><td class='num hit-count-good'>2&nbsp;</td><td><pre><span class='code nm-cov-good'>                    {</span></pre></td></tr>
<tr><td class='num'>94&nbsp;</td><td class='num hit-count-good'>4&nbsp;</td><td><pre><span class='code nm-cov-good'>                        var overage = result.Length - MaxSize;</span></pre></td></tr>
<tr><td class='num'>95&nbsp;</td><td class='num hit-count-good'>6&nbsp;</td><td><pre><span class='code nm-cov-good'>                        if (title.Length &gt; text.Length)</span></pre></td></tr>
<tr><td class='num'>96&nbsp;</td><td class='num hit-count-good'>2&nbsp;</td><td><pre><span class='code nm-cov-good'>                            title = TruncateOverage(title, overage);</span></pre></td></tr>
<tr><td class='num'>97&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                        else</span></pre></td></tr>
<tr><td class='num'>98&nbsp;</td><td class='num hit-count-good'>2&nbsp;</td><td><pre><span class='code nm-cov-good'>                            text = TruncateOverage(text, overage);</span></pre></td></tr>
<tr><td class='num'>99&nbsp;</td><td class='num hit-count-good'>4&nbsp;</td><td><pre><span class='code nm-cov-good'>                        return GetCommand(title, text, alertType, aggregationKey, sourceType, dateHappened, priority, hostname, tags, true);</span></pre></td></tr>
<tr><td class='num'>100&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                    }</span></pre></td></tr>
<tr><td class='num'>101&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                    else</span></pre></td></tr>
<tr><td class='num'>102&nbsp;</td><td class='num hit-count-good'>3&nbsp;</td><td><pre><span class='code nm-cov-good'>                        throw new Exception(string.Format(&quot;Event {0} payload is too big (more than 8kB)&quot;, title));</span></pre></td></tr>
<tr><td class='num'>103&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                }</span></pre></td></tr>
<tr><td class='num'>104&nbsp;</td><td class='num hit-count-good'>12&nbsp;</td><td><pre><span class='code nm-cov-good'>                return result;</span></pre></td></tr>
<tr><td class='num'>105&nbsp;</td><td class='num hit-count-good'>14&nbsp;</td><td><pre><span class='code nm-cov-good'>            }</span></pre></td></tr>
<tr><td class='num'>106&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'></span></pre></td></tr>
<tr><td class='num'>107&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>            private static string EscapeContent(string content)</span></pre></td></tr>
<tr><td class='num'>108&nbsp;</td><td class='num hit-count-good'>30&nbsp;</td><td><pre><span class='code nm-cov-good'>            {</span></pre></td></tr>
<tr><td class='num'>109&nbsp;</td><td class='num hit-count-good'>30&nbsp;</td><td><pre><span class='code nm-cov-good'>                return content</span></pre></td></tr>
<tr><td class='num'>110&nbsp;</td><td class='num hit-count-good'>30&nbsp;</td><td><pre><span class='code nm-cov-good'>                    .Replace(&quot;\r&quot;, &quot;&quot;)</span></pre></td></tr>
<tr><td class='num'>111&nbsp;</td><td class='num hit-count-good'>30&nbsp;</td><td><pre><span class='code nm-cov-good'>                    .Replace(&quot;\n&quot;, &quot;\\n&quot;);</span></pre></td></tr>
<tr><td class='num'>112&nbsp;</td><td class='num hit-count-good'>30&nbsp;</td><td><pre><span class='code nm-cov-good'>            }</span></pre></td></tr>
<tr><td class='num'>113&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'></span></pre></td></tr>
<tr><td class='num'>114&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>            private static string TruncateOverage(string str, int overage)</span></pre></td></tr>
<tr><td class='num'>115&nbsp;</td><td class='num hit-count-good'>2&nbsp;</td><td><pre><span class='code nm-cov-good'>            {</span></pre></td></tr>
<tr><td class='num'>116&nbsp;</td><td class='num hit-count-good'>6&nbsp;</td><td><pre><span class='code nm-cov-good'>                return str.Substring(0, str.Length - overage);</span></pre></td></tr>
<tr><td class='num'>117&nbsp;</td><td class='num hit-count-good'>2&nbsp;</td><td><pre><span class='code nm-cov-good'>            }</span></pre></td></tr>
<tr><td class='num'>118&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>        }</span></pre></td></tr>
<tr><td class='num'>119&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'></span></pre></td></tr>
<tr><td class='num'>120&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>        public class Counting : Metric { }</span></pre></td></tr>
<tr><td class='num'>121&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>        public class Timing : Metric { }</span></pre></td></tr>
<tr><td class='num'>122&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>        public class Gauge : Metric { }</span></pre></td></tr>
<tr><td class='num'>123&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>        public class Histogram : Metric { }</span></pre></td></tr>
<tr><td class='num'>124&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>        public class Meter : Metric { }</span></pre></td></tr>
<tr><td class='num'>125&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>        public class Set : Metric { }</span></pre></td></tr>
<tr><td class='num'>126&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'></span></pre></td></tr>
<tr><td class='num'>127&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'></span></pre></td></tr>
<tr><td class='num'>128&nbsp;</td><td class='num hit-count-good'>89&nbsp;</td><td><pre><span class='code nm-cov-good'>        public Statsd(IStatsdUDP udp, IRandomGenerator randomGenerator, IStopWatchFactory stopwatchFactory, string prefix)</span></pre></td></tr>
<tr><td class='num'>129&nbsp;</td><td class='num hit-count-good'>89&nbsp;</td><td><pre><span class='code nm-cov-good'>        {</span></pre></td></tr>
<tr><td class='num'>130&nbsp;</td><td class='num hit-count-good'>178&nbsp;</td><td><pre><span class='code nm-cov-good'>            StopwatchFactory = stopwatchFactory;</span></pre></td></tr>
<tr><td class='num'>131&nbsp;</td><td class='num hit-count-good'>178&nbsp;</td><td><pre><span class='code nm-cov-good'>            Udp = udp;</span></pre></td></tr>
<tr><td class='num'>132&nbsp;</td><td class='num hit-count-good'>178&nbsp;</td><td><pre><span class='code nm-cov-good'>            RandomGenerator = randomGenerator;</span></pre></td></tr>
<tr><td class='num'>133&nbsp;</td><td class='num hit-count-good'>89&nbsp;</td><td><pre><span class='code nm-cov-good'>            _prefix = prefix;</span></pre></td></tr>
<tr><td class='num'>134&nbsp;</td><td class='num hit-count-good'>89&nbsp;</td><td><pre><span class='code nm-cov-good'>        }</span></pre></td></tr>
<tr><td class='num'>135&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'></span></pre></td></tr>
<tr><td class='num'>136&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>        public Statsd(IStatsdUDP udp, IRandomGenerator randomGenerator, IStopWatchFactory stopwatchFactory)</span></pre></td></tr>
<tr><td class='num'>137&nbsp;</td><td class='num hit-count-good'>231&nbsp;</td><td><pre><span class='code nm-cov-good'>            : this(udp, randomGenerator, stopwatchFactory, string.Empty) { }</span></pre></td></tr>
<tr><td class='num'>138&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'></span></pre></td></tr>
<tr><td class='num'>139&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>        public Statsd(IStatsdUDP udp, string prefix)</span></pre></td></tr>
<tr><td class='num'>140&nbsp;</td><td class='num hit-count-good'>50&nbsp;</td><td><pre><span class='code nm-cov-good'>            : this(udp, new RandomGenerator(), new StopWatchFactory(), prefix) { }</span></pre></td></tr>
<tr><td class='num'>141&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'></span></pre></td></tr>
<tr><td class='num'>142&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>        public Statsd(IStatsdUDP udp)</span></pre></td></tr>
<tr><td class='num'>143&nbsp;</td><td class='num hit-count-good'>30&nbsp;</td><td><pre><span class='code nm-cov-good'>            : this(udp, &quot;&quot;) { }</span></pre></td></tr>
<tr><td class='num'>144&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'></span></pre></td></tr>
<tr><td class='num'>145&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>        public void Add&lt;TCommandType, T&gt;(string name, T value, double sampleRate = 1.0, string[] tags = null) where TCommandType : Metric</span></pre></td></tr>
<tr><td class='num'>146&nbsp;</td><td class='num hit-count-good'>46&nbsp;</td><td><pre><span class='code nm-cov-good'>        {</span></pre></td></tr>
<tr><td class='num'>147&nbsp;</td><td class='num hit-count-good'>138&nbsp;</td><td><pre><span class='code nm-cov-good'>            _commands.Add(Metric.GetCommand&lt;TCommandType, T&gt;(_prefix, name, value, sampleRate, tags));</span></pre></td></tr>
<tr><td class='num'>148&nbsp;</td><td class='num hit-count-good'>46&nbsp;</td><td><pre><span class='code nm-cov-good'>        }</span></pre></td></tr>
<tr><td class='num'>149&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'></span></pre></td></tr>
<tr><td class='num'>150&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>        public void Add(string title, string text, string alertType = null, string aggregationKey = null, string sourceType = null, int? dateHappened = null, string priority = null, string hostname = null, string[] tags = null)</span></pre></td></tr>
<tr><td class='num'>151&nbsp;</td><td class='num hit-count-bad'>0&nbsp;</td><td><pre><span class='code nm-cov-bad'>        {</span></pre></td></tr>
<tr><td class='num'>152&nbsp;</td><td class='num hit-count-bad'>0&nbsp;</td><td><pre><span class='code nm-cov-bad'>            _commands.Add(Event.GetCommand(title, text, alertType, aggregationKey, sourceType, dateHappened, priority, hostname, tags));</span></pre></td></tr>
<tr><td class='num'>153&nbsp;</td><td class='num hit-count-bad'>0&nbsp;</td><td><pre><span class='code nm-cov-bad'>        }</span></pre></td></tr>
<tr><td class='num'>154&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>        public void Send(string title, string text, string alertType = null, string aggregationKey = null, string sourceType = null, int? dateHappened = null, string priority = null, string hostname = null, string[] tags = null, bool truncateIfTooLong = false)</span></pre></td></tr>
<tr><td class='num'>155&nbsp;</td><td class='num hit-count-good'>13&nbsp;</td><td><pre><span class='code nm-cov-good'>        {</span></pre></td></tr>
<tr><td class='num'>156&nbsp;</td><td class='num hit-count-good'>38&nbsp;</td><td><pre><span class='code nm-cov-good'>            Send(Event.GetCommand(title, text, alertType, aggregationKey, sourceType, dateHappened, priority, hostname, tags, truncateIfTooLong));</span></pre></td></tr>
<tr><td class='num'>157&nbsp;</td><td class='num hit-count-good'>12&nbsp;</td><td><pre><span class='code nm-cov-good'>        }</span></pre></td></tr>
<tr><td class='num'>158&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>        public void Send&lt;TCommandType, T&gt;(string name, T value, double sampleRate = 1.0, string[] tags = null) where TCommandType : Metric</span></pre></td></tr>
<tr><td class='num'>159&nbsp;</td><td class='num hit-count-good'>108&nbsp;</td><td><pre><span class='code nm-cov-good'>        {</span></pre></td></tr>
<tr><td class='num'>160&nbsp;</td><td class='num hit-count-good'>324&nbsp;</td><td><pre><span class='code nm-cov-good'>            if (RandomGenerator.ShouldSend(sampleRate))</span></pre></td></tr>
<tr><td class='num'>161&nbsp;</td><td class='num hit-count-good'>108&nbsp;</td><td><pre><span class='code nm-cov-good'>            {</span></pre></td></tr>
<tr><td class='num'>162&nbsp;</td><td class='num hit-count-good'>324&nbsp;</td><td><pre><span class='code nm-cov-good'>                Send(Metric.GetCommand&lt;TCommandType, T&gt;(_prefix, name, value, sampleRate, tags));</span></pre></td></tr>
<tr><td class='num'>163&nbsp;</td><td class='num hit-count-good'>108&nbsp;</td><td><pre><span class='code nm-cov-good'>            }</span></pre></td></tr>
<tr><td class='num'>164&nbsp;</td><td class='num hit-count-good'>108&nbsp;</td><td><pre><span class='code nm-cov-good'>        }</span></pre></td></tr>
<tr><td class='num'>165&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'></span></pre></td></tr>
<tr><td class='num'>166&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'></span></pre></td></tr>
<tr><td class='num'>167&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>        public void Send(string command)</span></pre></td></tr>
<tr><td class='num'>168&nbsp;</td><td class='num hit-count-good'>1151&nbsp;</td><td><pre><span class='code nm-cov-good'>        {</span></pre></td></tr>
<tr><td class='num'>169&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>            try</span></pre></td></tr>
<tr><td class='num'>170&nbsp;</td><td class='num hit-count-good'>1151&nbsp;</td><td><pre><span class='code nm-cov-good'>            {</span></pre></td></tr>
<tr><td class='num'>171&nbsp;</td><td class='num hit-count-good'>3453&nbsp;</td><td><pre><span class='code nm-cov-good'>                Udp.Send(command);</span></pre></td></tr>
<tr><td class='num'>172&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                // clear buffer (keep existing behavior)</span></pre></td></tr>
<tr><td class='num'>173&nbsp;</td><td class='num hit-count-good'>3441&nbsp;</td><td><pre><span class='code nm-cov-good'>                if (Commands.Count &gt; 0)</span></pre></td></tr>
<tr><td class='num'>174&nbsp;</td><td class='num hit-count-good'>27&nbsp;</td><td><pre><span class='code nm-cov-good'>                    Commands = new List&lt;string&gt;();</span></pre></td></tr>
<tr><td class='num'>175&nbsp;</td><td class='num hit-count-good'>1147&nbsp;</td><td><pre><span class='code nm-cov-good'>            }</span></pre></td></tr>
<tr><td class='num'>176&nbsp;</td><td class='num hit-count-good'>1147&nbsp;</td><td><pre><span class='code nm-cov-good'>            catch (Exception e)</span></pre></td></tr>
<tr><td class='num'>177&nbsp;</td><td class='num hit-count-good'>4&nbsp;</td><td><pre><span class='code nm-cov-good'>            {</span></pre></td></tr>
<tr><td class='num'>178&nbsp;</td><td class='num hit-count-good'>12&nbsp;</td><td><pre><span class='code nm-cov-good'>                Debug.WriteLine(e.Message);</span></pre></td></tr>
<tr><td class='num'>179&nbsp;</td><td class='num hit-count-good'>4&nbsp;</td><td><pre><span class='code nm-cov-good'>            }</span></pre></td></tr>
<tr><td class='num'>180&nbsp;</td><td class='num hit-count-good'>1151&nbsp;</td><td><pre><span class='code nm-cov-good'>        }</span></pre></td></tr>
<tr><td class='num'>181&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'></span></pre></td></tr>
<tr><td class='num'>182&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>        public void Send()</span></pre></td></tr>
<tr><td class='num'>183&nbsp;</td><td class='num hit-count-good'>8&nbsp;</td><td><pre><span class='code nm-cov-good'>        {</span></pre></td></tr>
<tr><td class='num'>184&nbsp;</td><td class='num hit-count-good'>24&nbsp;</td><td><pre><span class='code nm-cov-good'>            int count = Commands.Count;</span></pre></td></tr>
<tr><td class='num'>185&nbsp;</td><td class='num hit-count-good'>9&nbsp;</td><td><pre><span class='code nm-cov-good'>            if (count &lt; 1) return;</span></pre></td></tr>
<tr><td class='num'>186&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'></span></pre></td></tr>
<tr><td class='num'>187&nbsp;</td><td class='num hit-count-good'>34&nbsp;</td><td><pre><span class='code nm-cov-good'>            Send(1 == count ? Commands[0] : string.Join(&quot;\n&quot;, Commands.ToArray()));</span></pre></td></tr>
<tr><td class='num'>188&nbsp;</td><td class='num hit-count-good'>8&nbsp;</td><td><pre><span class='code nm-cov-good'>        }</span></pre></td></tr>
<tr><td class='num'>189&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'></span></pre></td></tr>
<tr><td class='num'>190&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>        public void Add(Action actionToTime, string statName, double sampleRate = 1.0, string[] tags = null)</span></pre></td></tr>
<tr><td class='num'>191&nbsp;</td><td class='num hit-count-good'>4&nbsp;</td><td><pre><span class='code nm-cov-good'>        {</span></pre></td></tr>
<tr><td class='num'>192&nbsp;</td><td class='num hit-count-good'>12&nbsp;</td><td><pre><span class='code nm-cov-good'>            var stopwatch = StopwatchFactory.Get();</span></pre></td></tr>
<tr><td class='num'>193&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'></span></pre></td></tr>
<tr><td class='num'>194&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>            try</span></pre></td></tr>
<tr><td class='num'>195&nbsp;</td><td class='num hit-count-good'>4&nbsp;</td><td><pre><span class='code nm-cov-good'>            {</span></pre></td></tr>
<tr><td class='num'>196&nbsp;</td><td class='num hit-count-good'>8&nbsp;</td><td><pre><span class='code nm-cov-good'>                stopwatch.Start();</span></pre></td></tr>
<tr><td class='num'>197&nbsp;</td><td class='num hit-count-good'>8&nbsp;</td><td><pre><span class='code nm-cov-good'>                actionToTime();</span></pre></td></tr>
<tr><td class='num'>198&nbsp;</td><td class='num hit-count-good'>3&nbsp;</td><td><pre><span class='code nm-cov-good'>            }</span></pre></td></tr>
<tr><td class='num'>199&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>            finally</span></pre></td></tr>
<tr><td class='num'>200&nbsp;</td><td class='num hit-count-good'>4&nbsp;</td><td><pre><span class='code nm-cov-good'>            {</span></pre></td></tr>
<tr><td class='num'>201&nbsp;</td><td class='num hit-count-good'>8&nbsp;</td><td><pre><span class='code nm-cov-good'>                stopwatch.Stop();</span></pre></td></tr>
<tr><td class='num'>202&nbsp;</td><td class='num hit-count-good'>12&nbsp;</td><td><pre><span class='code nm-cov-good'>                Add&lt;Timing, int&gt;(statName, stopwatch.ElapsedMilliseconds(), sampleRate, tags);</span></pre></td></tr>
<tr><td class='num'>203&nbsp;</td><td class='num hit-count-good'>4&nbsp;</td><td><pre><span class='code nm-cov-good'>            }</span></pre></td></tr>
<tr><td class='num'>204&nbsp;</td><td class='num hit-count-good'>3&nbsp;</td><td><pre><span class='code nm-cov-good'>        }</span></pre></td></tr>
<tr><td class='num'>205&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'></span></pre></td></tr>
<tr><td class='num'>206&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>        public void Send(Action actionToTime, string statName, double sampleRate = 1.0, string[] tags = null)</span></pre></td></tr>
<tr><td class='num'>207&nbsp;</td><td class='num hit-count-good'>10&nbsp;</td><td><pre><span class='code nm-cov-good'>        {</span></pre></td></tr>
<tr><td class='num'>208&nbsp;</td><td class='num hit-count-good'>30&nbsp;</td><td><pre><span class='code nm-cov-good'>            var stopwatch = StopwatchFactory.Get();</span></pre></td></tr>
<tr><td class='num'>209&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'></span></pre></td></tr>
<tr><td class='num'>210&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>            try</span></pre></td></tr>
<tr><td class='num'>211&nbsp;</td><td class='num hit-count-good'>10&nbsp;</td><td><pre><span class='code nm-cov-good'>            {</span></pre></td></tr>
<tr><td class='num'>212&nbsp;</td><td class='num hit-count-good'>20&nbsp;</td><td><pre><span class='code nm-cov-good'>                stopwatch.Start();</span></pre></td></tr>
<tr><td class='num'>213&nbsp;</td><td class='num hit-count-good'>20&nbsp;</td><td><pre><span class='code nm-cov-good'>                actionToTime();</span></pre></td></tr>
<tr><td class='num'>214&nbsp;</td><td class='num hit-count-good'>9&nbsp;</td><td><pre><span class='code nm-cov-good'>            }</span></pre></td></tr>
<tr><td class='num'>215&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>            finally</span></pre></td></tr>
<tr><td class='num'>216&nbsp;</td><td class='num hit-count-good'>10&nbsp;</td><td><pre><span class='code nm-cov-good'>            {</span></pre></td></tr>
<tr><td class='num'>217&nbsp;</td><td class='num hit-count-good'>20&nbsp;</td><td><pre><span class='code nm-cov-good'>                stopwatch.Stop();</span></pre></td></tr>
<tr><td class='num'>218&nbsp;</td><td class='num hit-count-good'>30&nbsp;</td><td><pre><span class='code nm-cov-good'>                Send&lt;Timing, int&gt;(statName, stopwatch.ElapsedMilliseconds(), sampleRate, tags);</span></pre></td></tr>
<tr><td class='num'>219&nbsp;</td><td class='num hit-count-good'>10&nbsp;</td><td><pre><span class='code nm-cov-good'>            }</span></pre></td></tr>
<tr><td class='num'>220&nbsp;</td><td class='num hit-count-good'>9&nbsp;</td><td><pre><span class='code nm-cov-good'>        }</span></pre></td></tr>
<tr><td class='num'>221&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>    }</span></pre></td></tr>
<tr><td class='num'>222&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>}</span></pre></td></tr>
</table>
</body>
