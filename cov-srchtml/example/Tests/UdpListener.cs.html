<!DOCTYPE html>
<html>
<head><title>/Tests/UdpListener.cs</title></head>

<style>
.num {
  text-align:right;
  padding-right:3px;
  font-size:80%;
}
.hit-count-good {
  background-color:#73b973;
}
.hit-count-bad {
  background-color:#ff7373;
}
.code {
  font-family:monospace;
}
.nm-cov-good {
  background-color:#a2d0a2;
}
.nm-cov-bad {
  background-color:#ffa2a2;
}
pre {
  margin:0px;
}
body {
  font-family:sans-serif;
}
</style>
<body>
<table cellspacing='0' cellpadding='0'>
<tr><td class='num'>1&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>using System;</span></pre></td></tr>
<tr><td class='num'>2&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>using System.Net;</span></pre></td></tr>
<tr><td class='num'>3&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>using System.Net.Sockets;</span></pre></td></tr>
<tr><td class='num'>4&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>using System.Configuration;</span></pre></td></tr>
<tr><td class='num'>5&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>using System.Text;</span></pre></td></tr>
<tr><td class='num'>6&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>using System.Collections.Generic;</span></pre></td></tr>
<tr><td class='num'>7&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'></span></pre></td></tr>
<tr><td class='num'>8&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>namespace Tests</span></pre></td></tr>
<tr><td class='num'>9&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>{</span></pre></td></tr>
<tr><td class='num'>10&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>    namespace Helpers</span></pre></td></tr>
<tr><td class='num'>11&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>    {</span></pre></td></tr>
<tr><td class='num'>12&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>        // A small UDP server that can be used for testing.</span></pre></td></tr>
<tr><td class='num'>13&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>        // Stores a list of the last messages that were received by the server</span></pre></td></tr>
<tr><td class='num'>14&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>        // until they are accessed using GetAndClearLastMessages().</span></pre></td></tr>
<tr><td class='num'>15&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'></span></pre></td></tr>
<tr><td class='num'>16&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>        // By design received messages can only be read once. This</span></pre></td></tr>
<tr><td class='num'>17&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>        // allows one instance of the listener to be used across</span></pre></td></tr>
<tr><td class='num'>18&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>        // multiple tests without risk of the results of previous tests</span></pre></td></tr>
<tr><td class='num'>19&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>        // affecting the current one.</span></pre></td></tr>
<tr><td class='num'>20&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'></span></pre></td></tr>
<tr><td class='num'>21&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>        // Intended use:</span></pre></td></tr>
<tr><td class='num'>22&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>        // udpListener = new UdpListener(serverName, serverPort);</span></pre></td></tr>
<tr><td class='num'>23&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>        // listenThread = new Thread(new ParameterizedThreadStart(udpListener.Listen));</span></pre></td></tr>
<tr><td class='num'>24&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>        // listenThread.Start(n);</span></pre></td></tr>
<tr><td class='num'>25&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>        // { send n messages to the listener }</span></pre></td></tr>
<tr><td class='num'>26&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>        // while(listenThread.IsAlive); // wait for listen thread to receive message or time out</span></pre></td></tr>
<tr><td class='num'>27&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>        // List&lt;string&gt; receivedMessage = udpListener.GetAndClearLastMessages()</span></pre></td></tr>
<tr><td class='num'>28&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>        // { make sure that the received messages are what was expected }</span></pre></td></tr>
<tr><td class='num'>29&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>        public class UdpListener : IDisposable </span></pre></td></tr>
<tr><td class='num'>30&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>        {</span></pre></td></tr>
<tr><td class='num'>31&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>            List&lt;string&gt; lastReceivedMessages;</span></pre></td></tr>
<tr><td class='num'>32&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>            IPEndPoint localIpEndPoint;</span></pre></td></tr>
<tr><td class='num'>33&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>            IPEndPoint senderIpEndPoint;</span></pre></td></tr>
<tr><td class='num'>34&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>            UdpClient socket;</span></pre></td></tr>
<tr><td class='num'>35&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'></span></pre></td></tr>
<tr><td class='num'>36&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>            public UdpListener(string hostname, int port) </span></pre></td></tr>
<tr><td class='num'>37&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>            {</span></pre></td></tr>
<tr><td class='num'>38&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                lastReceivedMessages = new List&lt;string&gt;();</span></pre></td></tr>
<tr><td class='num'>39&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                localIpEndPoint = new IPEndPoint(IPAddress.Parse(hostname), port);</span></pre></td></tr>
<tr><td class='num'>40&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                socket = new UdpClient(localIpEndPoint);</span></pre></td></tr>
<tr><td class='num'>41&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                socket.Client.ReceiveTimeout = 1000;</span></pre></td></tr>
<tr><td class='num'>42&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                senderIpEndPoint = new IPEndPoint(IPAddress.Any, 0);</span></pre></td></tr>
<tr><td class='num'>43&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>            }</span></pre></td></tr>
<tr><td class='num'>44&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'></span></pre></td></tr>
<tr><td class='num'>45&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>            // Receive messages until it receives count of them or times out. </span></pre></td></tr>
<tr><td class='num'>46&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>            // This call is blocking; you may want to run it in a</span></pre></td></tr>
<tr><td class='num'>47&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>            // thread while you send the message.</span></pre></td></tr>
<tr><td class='num'>48&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>            public void Listen(object count = null)</span></pre></td></tr>
<tr><td class='num'>49&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>            {</span></pre></td></tr>
<tr><td class='num'>50&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                try</span></pre></td></tr>
<tr><td class='num'>51&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                {</span></pre></td></tr>
<tr><td class='num'>52&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                    if (count == null)</span></pre></td></tr>
<tr><td class='num'>53&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                        count = 1;</span></pre></td></tr>
<tr><td class='num'>54&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                    for (int i = 0; i &lt; (int)count; i++)</span></pre></td></tr>
<tr><td class='num'>55&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                    {</span></pre></td></tr>
<tr><td class='num'>56&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                        byte[] lastReceivedBytes = socket.Receive(ref senderIpEndPoint);</span></pre></td></tr>
<tr><td class='num'>57&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                        lastReceivedMessages.Add(Encoding.UTF8.GetString(lastReceivedBytes, 0,</span></pre></td></tr>
<tr><td class='num'>58&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                                                                          lastReceivedBytes.Length));</span></pre></td></tr>
<tr><td class='num'>59&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                    }</span></pre></td></tr>
<tr><td class='num'>60&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                }</span></pre></td></tr>
<tr><td class='num'>61&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                catch (SocketException ex)</span></pre></td></tr>
<tr><td class='num'>62&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                {</span></pre></td></tr>
<tr><td class='num'>63&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                    // If we timeout, stop listening.</span></pre></td></tr>
<tr><td class='num'>64&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                    // If we get another error, propagate it upwards.</span></pre></td></tr>
<tr><td class='num'>65&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                    if (ex.ErrorCode == 10060) // WSAETIMEDOUT; Timeout error</span></pre></td></tr>
<tr><td class='num'>66&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                        return;</span></pre></td></tr>
<tr><td class='num'>67&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                    else</span></pre></td></tr>
<tr><td class='num'>68&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                        throw;</span></pre></td></tr>
<tr><td class='num'>69&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                }</span></pre></td></tr>
<tr><td class='num'>70&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>            }</span></pre></td></tr>
<tr><td class='num'>71&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'></span></pre></td></tr>
<tr><td class='num'>72&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>            // Clear and return the message list. Clearing the list allows us to use the </span></pre></td></tr>
<tr><td class='num'>73&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>            // same UdpListener instance for several tests; we never have to worry about a </span></pre></td></tr>
<tr><td class='num'>74&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>            // message received from a previous test giving us a false positive.</span></pre></td></tr>
<tr><td class='num'>75&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>            public List&lt;string&gt; GetAndClearLastMessages()</span></pre></td></tr>
<tr><td class='num'>76&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>            {</span></pre></td></tr>
<tr><td class='num'>77&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                List&lt;string&gt; messagesToReturn = lastReceivedMessages;</span></pre></td></tr>
<tr><td class='num'>78&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                lastReceivedMessages = new List&lt;string&gt;();</span></pre></td></tr>
<tr><td class='num'>79&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                return messagesToReturn;</span></pre></td></tr>
<tr><td class='num'>80&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>            }</span></pre></td></tr>
<tr><td class='num'>81&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'></span></pre></td></tr>
<tr><td class='num'>82&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>            public void Dispose() </span></pre></td></tr>
<tr><td class='num'>83&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>            {</span></pre></td></tr>
<tr><td class='num'>84&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                socket.Close();</span></pre></td></tr>
<tr><td class='num'>85&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>            }</span></pre></td></tr>
<tr><td class='num'>86&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>        }</span></pre></td></tr>
<tr><td class='num'>87&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>    }</span></pre></td></tr>
<tr><td class='num'>88&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>}</span></pre></td></tr>
</table>
</body>
