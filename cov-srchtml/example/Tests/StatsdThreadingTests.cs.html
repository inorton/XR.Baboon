<!DOCTYPE html>
<html>
<head><title>/Tests/StatsdThreadingTests.cs</title></head>

<style>
.num {
  text-align:right;
  padding-right:3px;
  font-size:80%;
}
.hit-count-good {
  background-color:#73b973;
}
.hit-count-bad {
  background-color:#ff7373;
}
.code {
  font-family:monospace;
}
.nm-cov-good {
  background-color:#a2d0a2;
}
.nm-cov-bad {
  background-color:#ffa2a2;
}
pre {
  margin:0px;
}
body {
  font-family:sans-serif;
}
</style>
<body>
<table cellspacing='0' cellpadding='0'>
<tr><td class='num'>1&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>using System;</span></pre></td></tr>
<tr><td class='num'>2&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>using System.Collections.Generic;</span></pre></td></tr>
<tr><td class='num'>3&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>using System.Threading;</span></pre></td></tr>
<tr><td class='num'>4&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'></span></pre></td></tr>
<tr><td class='num'>5&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>using NUnit.Framework;</span></pre></td></tr>
<tr><td class='num'>6&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'></span></pre></td></tr>
<tr><td class='num'>7&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>using StatsdClient;</span></pre></td></tr>
<tr><td class='num'>8&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'></span></pre></td></tr>
<tr><td class='num'>9&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>namespace Tests</span></pre></td></tr>
<tr><td class='num'>10&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>{</span></pre></td></tr>
<tr><td class='num'>11&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>    [TestFixture]</span></pre></td></tr>
<tr><td class='num'>12&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>    public class StatsdThreadingTests</span></pre></td></tr>
<tr><td class='num'>13&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>    {</span></pre></td></tr>
<tr><td class='num'>14&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>        [Test]</span></pre></td></tr>
<tr><td class='num'>15&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>        public void single_send_is_thread_safe()</span></pre></td></tr>
<tr><td class='num'>16&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>        {</span></pre></td></tr>
<tr><td class='num'>17&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>            var counts = new CountingUDP();</span></pre></td></tr>
<tr><td class='num'>18&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>            var test = new Statsd(counts);</span></pre></td></tr>
<tr><td class='num'>19&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'></span></pre></td></tr>
<tr><td class='num'>20&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>            // send some commands in parallel, `command&#39; just being a number in sequence</span></pre></td></tr>
<tr><td class='num'>21&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>            int sends = 1024, threads = 2; // appears sufficient to surface error most of the time but may vary by machine</span></pre></td></tr>
<tr><td class='num'>22&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>            var sent = new ManualResetEvent[threads];</span></pre></td></tr>
<tr><td class='num'>23&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>            for (int i = 0; i &lt; threads; i++)</span></pre></td></tr>
<tr><td class='num'>24&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>            {</span></pre></td></tr>
<tr><td class='num'>25&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                var done = sent[i] = new ManualResetEvent(false);</span></pre></td></tr>
<tr><td class='num'>26&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                ThreadPool.QueueUserWorkItem(CreateSender(sends, threads, i, test, done));</span></pre></td></tr>
<tr><td class='num'>27&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>            }</span></pre></td></tr>
<tr><td class='num'>28&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>            // allow threads to complete, cleanup</span></pre></td></tr>
<tr><td class='num'>29&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>            WaitHandle.WaitAll(sent);</span></pre></td></tr>
<tr><td class='num'>30&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>            foreach (IDisposable d in sent)</span></pre></td></tr>
<tr><td class='num'>31&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                d.Dispose();</span></pre></td></tr>
<tr><td class='num'>32&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'></span></pre></td></tr>
<tr><td class='num'>33&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>            counts.ExpectSequence(sends);</span></pre></td></tr>
<tr><td class='num'>34&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>        }</span></pre></td></tr>
<tr><td class='num'>35&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'></span></pre></td></tr>
<tr><td class='num'>36&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>        static WaitCallback CreateSender(int sends, int threads, int which, IStatsd statsd, ManualResetEvent done)</span></pre></td></tr>
<tr><td class='num'>37&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>        {</span></pre></td></tr>
<tr><td class='num'>38&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>            return x =&gt; {</span></pre></td></tr>
<tr><td class='num'>39&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                for (int i = 0; i &lt; sends; i++)</span></pre></td></tr>
<tr><td class='num'>40&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                    if (which == (i % threads))</span></pre></td></tr>
<tr><td class='num'>41&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                        statsd.Send(i.ToString());</span></pre></td></tr>
<tr><td class='num'>42&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                done.Set();</span></pre></td></tr>
<tr><td class='num'>43&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>            };</span></pre></td></tr>
<tr><td class='num'>44&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>        }</span></pre></td></tr>
<tr><td class='num'>45&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'></span></pre></td></tr>
<tr><td class='num'>46&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>        class CountingUDP : IStatsdUDP</span></pre></td></tr>
<tr><td class='num'>47&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>        {</span></pre></td></tr>
<tr><td class='num'>48&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>            readonly IDictionary&lt;string, int&gt; _commands = new Dictionary&lt;string, int&gt;();</span></pre></td></tr>
<tr><td class='num'>49&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'></span></pre></td></tr>
<tr><td class='num'>50&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>            public void Send(string command)</span></pre></td></tr>
<tr><td class='num'>51&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>            {</span></pre></td></tr>
<tr><td class='num'>52&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                lock (_commands)</span></pre></td></tr>
<tr><td class='num'>53&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                {</span></pre></td></tr>
<tr><td class='num'>54&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                    int count;</span></pre></td></tr>
<tr><td class='num'>55&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                    if (_commands.TryGetValue(command, out count))</span></pre></td></tr>
<tr><td class='num'>56&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                        count++;</span></pre></td></tr>
<tr><td class='num'>57&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                    else</span></pre></td></tr>
<tr><td class='num'>58&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                        count = 1;</span></pre></td></tr>
<tr><td class='num'>59&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                    _commands[command] = count;</span></pre></td></tr>
<tr><td class='num'>60&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                }</span></pre></td></tr>
<tr><td class='num'>61&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>            }</span></pre></td></tr>
<tr><td class='num'>62&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'></span></pre></td></tr>
<tr><td class='num'>63&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>            public void ExpectSequence(int n)</span></pre></td></tr>
<tr><td class='num'>64&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>            {</span></pre></td></tr>
<tr><td class='num'>65&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                int empty, missing = 0, dupes = 0;</span></pre></td></tr>
<tr><td class='num'>66&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                if (!_commands.TryGetValue(&quot;&quot;, out empty))</span></pre></td></tr>
<tr><td class='num'>67&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                    empty = 0;</span></pre></td></tr>
<tr><td class='num'>68&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'></span></pre></td></tr>
<tr><td class='num'>69&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                for (int i = 0; i &lt; n; i++)</span></pre></td></tr>
<tr><td class='num'>70&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                {</span></pre></td></tr>
<tr><td class='num'>71&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                    int count;</span></pre></td></tr>
<tr><td class='num'>72&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                    if (!_commands.TryGetValue(i.ToString(), out count))</span></pre></td></tr>
<tr><td class='num'>73&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                    {</span></pre></td></tr>
<tr><td class='num'>74&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                        missing++;</span></pre></td></tr>
<tr><td class='num'>75&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                        Console.Error.WriteLine(&quot;Missing command {0}&quot;, i);</span></pre></td></tr>
<tr><td class='num'>76&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                    }</span></pre></td></tr>
<tr><td class='num'>77&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                    else if (count &gt; 1)</span></pre></td></tr>
<tr><td class='num'>78&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                    {</span></pre></td></tr>
<tr><td class='num'>79&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                        dupes++;</span></pre></td></tr>
<tr><td class='num'>80&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                        Console.Error.WriteLine(&quot;{0} duplicates of command {1}&quot;, count, i);</span></pre></td></tr>
<tr><td class='num'>81&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                    }</span></pre></td></tr>
<tr><td class='num'>82&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                }</span></pre></td></tr>
<tr><td class='num'>83&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'></span></pre></td></tr>
<tr><td class='num'>84&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                if (empty &gt; 0 || missing &gt; 0 || dupes &gt; 0)</span></pre></td></tr>
<tr><td class='num'>85&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>                    Assert.Fail(&quot;{0} empty command(s), {1} missing, {2} duplicate(s)&quot;, empty, missing, dupes);</span></pre></td></tr>
<tr><td class='num'>86&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>            }</span></pre></td></tr>
<tr><td class='num'>87&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>        }</span></pre></td></tr>
<tr><td class='num'>88&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>    }</span></pre></td></tr>
<tr><td class='num'>89&nbsp;</td><td class='num'>&nbsp;&nbsp;</td><td><pre><span class='code'>}</span></pre></td></tr>
</table>
</body>
